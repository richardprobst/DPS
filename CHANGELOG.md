# DPS by PRObst ‚Äî CHANGELOG

**Autor:** PRObst  
**Site:** [www.probst.pro](https://www.probst.pro)

Este documento registra, em ordem cronol√≥gica inversa, todas as altera√ß√µes lan√ßadas do DPS by PRObst. Mantenha-o sempre atualizado para que equipe, parceiros e clientes tenham clareza sobre evolu√ß√µes, corre√ß√µes e impactos.

## Rela√ß√£o com outros documentos

Este CHANGELOG complementa e se relaciona com:
- **ANALYSIS.md**: cont√©m detalhes arquiteturais, fluxos internos de integra√ß√£o e contratos de hooks entre n√∫cleo e add-ons. Consulte-o para entender *como* o sistema funciona internamente.
- **AGENTS.md**: define pol√≠ticas de versionamento, git-flow, conven√ß√µes de c√≥digo e obriga√ß√µes de documenta√ß√£o. Consulte-o para entender *como* contribuir e manter o c√≥digo.

Este CHANGELOG registra *o que* mudou, em qual vers√£o e com qual impacto vis√≠vel para usu√°rios e integradores.

## Como atualizar este changelog
1. **Abra uma nova se√ß√£o** para cada vers√£o liberada, usando o formato `AAAA-MM-DD` para a data real do lan√ßamento.
2. **Agrupe entradas por categoria**, mesmo que alguma fique vazia (remova a categoria vazia apenas se n√£o houver conte√∫do relevante).
3. **Use linguagem imperativa e concisa**, indicando impacto vis√≠vel para usu√°rios e integradores.
4. **Referencie tickets ou links**, quando √∫til, no final de cada item.
5. **N√£o liste altera√ß√µes internas triviais** (refactors menores ou ajustes de estilo) a menos que afetem integra√ß√µes ou documenta√ß√£o.

### Fluxo de release

Antes de criar uma nova vers√£o oficial:

1. **Mover entradas de `[Unreleased]` para nova se√ß√£o datada**: crie uma se√ß√£o `### [AAAA-MM-DD] vX.Y.Z` e transfira todas as entradas acumuladas de `[Unreleased]` para ela.
2. **Deixar `[Unreleased]` pronto para a pr√≥xima rodada**: mantenha a se√ß√£o `[Unreleased]` com categorias vazias prontas para receber novas mudan√ßas.
3. **Conferir coer√™ncia com ANALYSIS.md e AGENTS.md**:
   - Se houve mudan√ßas de arquitetura, cria√ß√£o de helpers, novos hooks ou altera√ß√µes de fluxo financeiro, valide que o `ANALYSIS.md` reflete essas mudan√ßas.
   - Se houve mudan√ßas em pol√≠ticas de versionamento, conven√ß√µes de c√≥digo ou estrutura de add-ons, valide que o `AGENTS.md` est√° atualizado.
4. **Criar tag de release**: ap√≥s garantir que todos os arquivos est√£o consistentes, crie a tag anotada `git tag -a vX.Y.Z -m "Descri√ß√£o da vers√£o"` e publique.

## Estrutura recomendada
- Todas as vers√µes listadas do mais recente para o mais antigo.
- Cada vers√£o organizada por data de publica√ß√£o.
- Categorias oficiais (utilize-as neste exato t√≠tulo e ordem quando poss√≠vel):
  - Added (Adicionado)
  - Changed (Alterado)
  - Fixed (Corrigido)
  - Removed (Removido)
  - Deprecated (Depreciado)
  - Security (Seguran√ßa)
  - Refactoring (Interno) ‚Äî *opcional, apenas para grandes refatora√ß√µes que impactam arquitetura ou helpers globais*

## Exemplos e placeholders

### [YYYY-MM-DD] vX.Y.Z ‚Äî Nome da vers√£o (opcional)

#### Added (Adicionado)
- Adicione aqui novas funcionalidades, endpoints, p√°ginas do painel ou comandos WP-CLI.
- Exemplo: "Implementada aba de assinaturas com integra√ß√£o ao gateway XPTO." (TCK-123)

#### Changed (Alterado)
- Registre altera√ß√µes de comportamento, migra√ß√µes de dados ou ajustes de UX.
- Exemplo: "Reordenada navega√ß√£o das abas para destacar Agendamentos." (TCK-124)

#### Fixed (Corrigido)
- Liste corre√ß√µes de bugs, incluindo contexto e impacto.
- Exemplo: "Corrigido c√°lculo de taxas na tabela `dps_transacoes` em assinaturas recorrentes." (TCK-125)

#### Removed (Removido)
- Documente remo√ß√µes de APIs, *hooks* ou configura√ß√µes.
- Exemplo: "Removido shortcode legado `dps_old_checkout` em favor do `dps_checkout`."

#### Deprecated (Depreciado)
- Marque funcionalidades em descontinua√ß√£o e a vers√£o alvo de remo√ß√£o.
- Exemplo: "Depreciada op√ß√£o `dps_enable_legacy_assets`; remo√ß√£o prevista para vX.Y." (TCK-126)

#### Security (Seguran√ßa)
- Registre corre√ß√µes de seguran√ßa, incluindo CVE/avisos internos.
- Exemplo: "Sanitiza√ß√£o refor√ßada nos par√¢metros de webhook `dps_webhook_token`." (TCK-127)

#### Refactoring (Interno)
- Liste apenas grandes refatora√ß√µes que impactam arquitetura, estrutura de add-ons ou cria√ß√£o de helpers globais.
- Refatora√ß√µes triviais (renomea√ß√£o de vari√°veis, quebra de fun√ß√µes pequenas) devem ficar fora do changelog.
- Exemplo: "Criadas classes helper `DPS_Money_Helper`, `DPS_URL_Builder`, `DPS_Query_Helper` e `DPS_Request_Validator` para padronizar opera√ß√µes comuns." (TCK-128)
- Exemplo: "Documentado padr√£o de estrutura de arquivos para add-ons em `ANALYSIS.md` com exemplos pr√°ticos em `refactoring-examples.php`." (TCK-129)

---

### [Unreleased]

#### Added (Adicionado)
- **AI Add-on (v1.6.0)**: Chat P√∫blico para Visitantes do Site
  - **Novo Shortcode `[dps_ai_public_chat]`**: Chat de IA aberto para visitantes n√£o logados
    - Permite que visitantes tirem d√∫vidas sobre servi√ßos de Banho e Tosa
    - N√£o requer autentica√ß√£o (diferente do chat do Portal do Cliente)
    - Foco em informa√ß√µes gerais: pre√ßos, hor√°rios, servi√ßos, formas de pagamento
  - **Modos de Exibi√ß√£o**:
    - `mode="inline"`: Widget integrado na p√°gina
    - `mode="floating"`: Bot√£o flutuante no canto da tela
  - **Temas Visuais**:
    - `theme="light"`: Tema claro (padr√£o)
    - `theme="dark"`: Tema escuro
    - `primary_color="#hex"`: Cor principal customiz√°vel
  - **FAQs Personaliz√°veis**:
    - Bot√µes clic√°veis com perguntas frequentes
    - Configur√°vel via painel administrativo
    - FAQs padr√£o inclu√≠das
  - **Rate Limiting por IP**:
    - Limite de 10 perguntas por minuto
    - Limite de 60 perguntas por hora
    - Prote√ß√£o contra abuso por visitantes
  - **Configura√ß√µes Administrativas**:
    - Se√ß√£o dedicada "Chat P√∫blico para Visitantes"
    - Campo para informa√ß√µes do neg√≥cio (hor√°rios, endere√ßo, pagamentos)
    - Instru√ß√µes adicionais para personaliza√ß√£o do comportamento
  - **Integra√ß√£o com M√©tricas**:
    - Registro de intera√ß√µes (perguntas, tempo de resposta)
    - Registro de feedback (üëç/üëé)
    - M√©tricas agregadas no dashboard de Analytics
  - **System Prompt Espec√≠fico**:
    - Prompt otimizado para visitantes
    - Foco em informa√ß√µes p√∫blicas (sem dados de clientes)
    - Tom amig√°vel com uso de emojis üê∂üê±
  - **Novos Arquivos**:
    - `includes/class-dps-ai-public-chat.php`: Classe principal
    - `assets/css/dps-ai-public-chat.css`: Estilos responsivos
    - `assets/js/dps-ai-public-chat.js`: Interatividade do chat

- **Loyalty Add-on (v1.2.0)**: Multiplicador de n√≠vel, compartilhamento e exporta√ß√£o
  - **Multiplicador de N√≠vel Ativo**: Pontos agora s√£o multiplicados por n√≠vel de fidelidade
    - Bronze: 1x (padr√£o)
    - Prata: 1.5x (a partir de 500 pontos)
    - Ouro: 2x (a partir de 1000 pontos)
  - **Compartilhamento via WhatsApp**: Bot√£o para compartilhar c√≥digo de indica√ß√£o
    - Mensagem pr√©-formatada com c√≥digo e link
    - Abre WhatsApp Web ou app mobile
  - **Exporta√ß√£o CSV de Indica√ß√µes**: Bot√£o para baixar relat√≥rio
    - Inclui indicador, indicado, c√≥digo, data, status e recompensas
    - Formato CSV com BOM UTF-8 para compatibilidade com Excel
  - **Novos M√©todos na API `DPS_Loyalty_API`**:
    - `calculate_points_for_amount($amount, $client_id)`: preview de pontos antes de conceder
    - `get_top_clients($limit)`: ranking de clientes por pontos
    - `get_clients_by_tier()`: contagem de clientes por n√≠vel
    - `export_referrals_csv($args)`: exporta√ß√£o de indica√ß√µes
  - **Novos Hooks**:
    - `dps_loyalty_points_awarded_appointment`: disparado ap√≥s conceder pontos por atendimento
    - `dps_loyalty_tier_bonus_applied`: disparado quando b√¥nus de n√≠vel √© aplicado
  - **UX Melhorada**:
    - Labels de contexto traduzidos no hist√≥rico de pontos
    - Datas formatadas em dd/mm/yyyy HH:mm
    - Se√ß√£o de indica√ß√£o redesenhada com box, link e bot√µes de a√ß√£o
    - Contador de indica√ß√µes na aba
  - **Documenta√ß√£o**: An√°lise profunda atualizada em `docs/analysis/LOYALTY_ADDON_ANALYSIS.md`

- **AI Add-on (v1.5.0)**: Nova vers√£o com 8 funcionalidades principais
  - **1. Sugest√µes de Perguntas Frequentes (FAQs)**:
    - Bot√µes clic√°veis exibidos no widget para perguntas comuns
    - FAQs personaliz√°veis na p√°gina de configura√ß√µes
    - FAQs padr√£o inclu√≠das (hor√°rio, pre√ßos, agendamento, etc.)
  - **2. Feedback Positivo/Negativo**:
    - Bot√µes üëç/üëé ap√≥s cada resposta da IA
    - Registro de feedback em tabela customizada `dps_ai_feedback`
    - Handler AJAX `dps_ai_submit_feedback` para salvar feedback
  - **3. M√©tricas de Uso**:
    - Tabela `dps_ai_metrics` para registro de uso di√°rio
    - Contabiliza√ß√£o de perguntas, tokens, erros, tempo de resposta
    - Registro por cliente e por dia
  - **4. Base de Conhecimento**:
    - CPT `dps_ai_knowledge` para FAQs/artigos personalizados
    - Taxonomia para categorizar artigos
    - Palavras-chave para ativa√ß√£o autom√°tica no contexto
    - Interface admin para gerenciar conhecimento
  - **5. Widget Flutuante Alternativo**:
    - Modo "chat bubble" no canto da tela
    - Op√ß√£o de posi√ß√£o (inferior direito/esquerdo)
    - Anima√ß√£o de abertura/fechamento suave
    - Toggle entre modos na configura√ß√£o
  - **6. Suporte a M√∫ltiplos Idiomas**:
    - Op√ß√µes: Portugu√™s (Brasil), English, Espa√±ol, Autom√°tico
    - Instru√ß√£o de idioma enviada ao modelo GPT
    - Interface traduz√≠vel via text domain
  - **7. Agendamento via Chat**:
    - Verifica√ß√£o de disponibilidade por data
    - Dois modos: solicitar confirma√ß√£o ou agendamento direto
    - Handlers AJAX para disponibilidade e solicita√ß√£o
    - Notifica√ß√£o por e-mail para admins (modo solicita√ß√£o)
    - Cria√ß√£o autom√°tica de agendamentos (modo direto)
  - **8. Dashboard de Analytics**:
    - P√°gina admin com m√©tricas visuais em cards
    - Filtro por per√≠odo (data in√≠cio/fim)
    - M√©tricas: perguntas, tokens, custos, tempo de resposta
    - Tabela de feedback recente
    - Uso di√°rio com hist√≥rico
  - **Classes Novas**:
    - `DPS_AI_Analytics`: m√©tricas, feedback, custos
    - `DPS_AI_Knowledge_Base`: CPT, taxonomia, artigos
    - `DPS_AI_Scheduler`: agendamento via chat

- **AI Add-on (v1.4.0)**: Melhorias de interface e funcionalidades
  - **Modelos GPT Atualizados**: Adicionados GPT-4o Mini (recomendado), GPT-4o e GPT-4 Turbo
    - GPT-4o Mini como modelo padr√£o recomendado para melhor custo/benef√≠cio em 2024+
    - Mantido GPT-3.5 Turbo como op√ß√£o legada
  - **Teste de Conex√£o**: Bot√£o para validar API key diretamente na p√°gina de configura√ß√µes
    - Handler AJAX `dps_ai_test_connection` com verifica√ß√£o de nonce e permiss√µes
    - Feedback visual de sucesso/erro em tempo real
  - **Tabela de Custos**: Informa√ß√µes de custo estimado por modelo na p√°gina admin
  - **Interface do Widget Modernizada**:
    - Novo design com header azul gradiente e √≠cone de rob√¥
    - Badge de status "Online" com anima√ß√£o de pulse
    - Clique no header inteiro para expandir/recolher
    - Bot√£o de envio circular com √≠cone de seta
    - Mensagens com estilo de chat moderno (bolhas coloridas)
    - Textarea com auto-resize din√¢mico
    - Scrollbar estilizada no container de mensagens
    - Layout horizontal de input em desktop, vertical em mobile
  - **Hist√≥rico de Conversas**: Persist√™ncia via sessionStorage
    - Mensagens mantidas durante a sess√£o do navegador
    - Fun√ß√£o `dpsAIClearHistory()` para limpar manualmente
  - **UX Aprimorada**:
    - Envio com Enter (sem Shift) al√©m de Ctrl+Enter
    - Dica de atalho de teclado vis√≠vel
    - Anima√ß√µes suaves de slide para toggle
    - Foco autom√°tico no textarea ao expandir

- **Push Notifications Add-on (v1.0.0)**: Notifica√ß√µes push nativas do navegador
  - **Web Push API**: Implementa√ß√£o nativa sem depend√™ncia de servi√ßos externos
    - Chaves VAPID geradas automaticamente na ativa√ß√£o
    - Service Worker para receber notifica√ß√µes em segundo plano
    - Suporte multi-dispositivo por usu√°rio
  - **Eventos notificados**:
    - Novos agendamentos (`dps_base_after_save_appointment`)
    - Mudan√ßas de status (`dps_appointment_status_changed`)
    - Reagendamentos (`dps_appointment_rescheduled`)
  - **Interface administrativa**:
    - P√°gina de configura√ß√µes em DPS by PRObst > Push Notifications
    - Indicador de status com cores (inscrito/n√£o inscrito/negado)
    - Bot√£o para ativar notifica√ß√µes no navegador atual
    - Bot√£o para enviar notifica√ß√£o de teste
    - Checkboxes para selecionar eventos a notificar
  - **API p√∫blica**:
    - `DPS_Push_API::send_to_user($user_id, $payload)` - Envia para usu√°rio espec√≠fico
    - `DPS_Push_API::send_to_all_admins($payload, $exclude_ids)` - Envia para todos os admins
    - `DPS_Push_API::generate_vapid_keys()` - Gera novo par de chaves VAPID
  - **Seguran√ßa**:
    - Nonces em todas as a√ß√µes AJAX
    - Verifica√ß√£o de capability `manage_options`
    - Chaves VAPID √∫nicas por instala√ß√£o
    - Remo√ß√£o autom√°tica de inscri√ß√µes expiradas
  - **Arquivos**:
    - `desi-pet-shower-push-addon.php` - Plugin principal
    - `includes/class-dps-push-api.php` - API de envio
    - `assets/js/push-addon.js` - JavaScript do admin
    - `assets/js/push-sw.js` - Service Worker
    - `assets/css/push-addon.css` - Estilos da interface
  - **Requisitos**: HTTPS obrigat√≥rio, PHP 7.4+, navegadores modernos
- **Agenda Add-on (v1.3.2)**: Funcionalidades administrativas avan√ßadas
  - **Dashboard de KPIs**: Cards de m√©tricas no topo da agenda
    - Agendamentos pendentes/finalizados do dia
    - Faturamento estimado baseado em servi√ßos
    - Taxa de cancelamento semanal
    - M√©dia de atendimentos di√°rios (√∫ltimos 7 dias)
  - **A√ß√µes em Lote**: Atualiza√ß√£o de m√∫ltiplos agendamentos de uma s√≥ vez
    - Checkbox de sele√ß√£o em cada linha da tabela
    - Checkbox "selecionar todos" no header
    - Barra de a√ß√µes flutuante (sticky) com bot√µes:
      - Finalizar selecionados
      - Marcar como pago
      - Cancelar selecionados
    - Handler AJAX `dps_bulk_update_status` com valida√ß√£o de nonce
  - **Reagendamento R√°pido**: Modal simplificado para alterar data/hora
    - Bot√£o "üìÖ Reagendar" em cada linha da tabela
    - Modal com apenas campos de data e hora
    - Handler AJAX `dps_quick_reschedule`
    - Hook `dps_appointment_rescheduled` para notifica√ß√µes
  - **Hist√≥rico de Altera√ß√µes**: Registro de todas as mudan√ßas em agendamentos
    - Metadado `_dps_appointment_history` com at√© 50 entradas
    - Registra: cria√ß√£o, altera√ß√£o de status, reagendamento
    - Indicador visual "üìú" quando h√° hist√≥rico
    - Handler AJAX `dps_get_appointment_history`
    - Integra√ß√£o com hook `dps_appointment_status_changed`
  - **API de KPIs**: Handler AJAX `dps_get_admin_kpis` para consulta program√°tica
  - **CSS**: Novos estilos para dashboard, barra de lote, modal de reagendamento
  - **JavaScript**: L√≥gica para sele√ß√£o em lote, modal de reagendamento, hist√≥rico
- **Constante `DPS_DISABLE_CACHE`**: Nova constante para desabilitar completamente o cache do sistema
  - √ötil para desenvolvimento, testes e debug de problemas relacionados a dados em cache
  - Afeta todos os transients de cache de dados (pets, clientes, servi√ßos, estat√≠sticas, m√©tricas, contexto de IA)
  - N√£o afeta caches de seguran√ßa (tokens de login, rate limiting, tentativas de login)
  - Para desabilitar, adicione `define( 'DPS_DISABLE_CACHE', true );` no wp-config.php
  - Documenta√ß√£o completa no README do plugin base
- **Portal do Cliente v2.3.0**: Navega√ß√£o por Tabs e Widget de Chat em tempo real
  - **Navega√ß√£o por Tabs**: Interface reorganizada em 4 abas (In√≠cio, Agendamentos, Galeria, Meus Dados)
    - Tab "In√≠cio": Pr√≥ximo agendamento + pend√™ncias financeiras + programa de fidelidade
    - Tab "Agendamentos": Hist√≥rico completo de atendimentos
    - Tab "Galeria": Fotos dos pets
    - Tab "Meus Dados": Formul√°rios de atualiza√ß√£o de dados pessoais e pets
  - **Widget de Chat Flutuante**: Comunica√ß√£o em tempo real com a equipe
    - Bot√£o flutuante no canto inferior direito
    - Badge de mensagens n√£o lidas com anima√ß√£o
    - AJAX polling a cada 10 segundos para novas mensagens
    - Rate limiting (m√°ximo 10 mensagens/minuto por cliente)
    - Notifica√ß√£o autom√°tica ao admin via Communications API
  - **Melhorias de UX**:
    - Acessibilidade: ARIA roles, labels e states em tabs e chat
    - Responsividade: Tabs com scroll horizontal em mobile, chat fullscreen
    - Anima√ß√µes CSS suaves em transi√ß√µes de tab e chat
  - **Handlers AJAX**:
    - `dps_chat_get_messages`: Obt√©m hist√≥rico de mensagens
    - `dps_chat_send_message`: Envia nova mensagem do cliente
    - `dps_chat_mark_read`: Marca mensagens do admin como lidas
- **Documenta√ß√£o de compatibilidade**: Criado documento `docs/compatibility/COMPATIBILITY_ANALYSIS.md` com an√°lise detalhada de compatibilidade PHP 8.3+/8.4, WordPress 6.9 e tema Astra
- **Helper dps_get_page_by_title_compat()**: Nova fun√ß√£o utilit√°ria no Portal do Cliente para substituir `get_page_by_title()` deprecado
- **Debugging Add-on (v1.1.0)**: Melhorias significativas de funcionalidade, c√≥digo e UX
  - **Novas funcionalidades**:
    - Busca client-side com highlight de termos encontrados
    - Filtros por tipo de erro (Fatal, Warning, Notice, Deprecated, Parse, DB Error, Exception)
    - Cards de estat√≠sticas com contagem por tipo de erro
    - Exporta√ß√£o/download do arquivo de log
    - Bot√£o de c√≥pia r√°pida do log para √°rea de transfer√™ncia
    - Alerta visual na admin bar quando h√° erros fatais (badge vermelho com anima√ß√£o pulse)
    - Sincroniza√ß√£o autom√°tica de op√ß√µes com estado real do wp-config.php
  - **Melhorias de c√≥digo**:
    - Novo m√©todo `sync_options_with_config()` para manter interface consistente com arquivo
    - M√©todo `get_entry_stats()` para estat√≠sticas de entradas do log
    - M√©todo `get_formatted_content()` agora suporta filtro por tipo
    - Cache de entradas parseadas para performance
    - Suporte a tipos adicionais de erro: Exception, Catchable
  - **Melhorias de UX**:
    - Interface com duas abas (Configura√ß√µes e Visualizador de Log)
    - Dashboard de estat√≠sticas no topo do visualizador
    - Barra de filtros com bot√µes coloridos por tipo de erro
    - Campo de busca com debounce e limpar
    - Feedback visual de sucesso/erro ao copiar
  - **Novos assets**:
    - `assets/js/debugging-admin.js` - busca, filtros e c√≥pia de logs
    - CSS expandido com estilos para stats, filtros e busca
  - **Admin bar melhorada**:
    - Contador diferenciado para erros fatais (badge vermelho)
    - Anima√ß√£o pulse para alertar sobre fatais
    - Link direto para visualizar erros fatais
    - Background visual quando h√° erros fatais
  - **Impacto**: Experi√™ncia de debugging muito mais produtiva com busca, filtros e alertas visuais
- **Debugging Add-on (v1.0.0)**: Novo add-on para gerenciamento de debug do WordPress
  - **Funcionalidades principais**:
    - Configura√ß√£o de constantes de debug (WP_DEBUG, WP_DEBUG_LOG, WP_DEBUG_DISPLAY, SCRIPT_DEBUG, SAVEQUERIES, WP_DISABLE_FATAL_ERROR_HANDLER) diretamente via interface administrativa
    - Modifica√ß√£o segura do wp-config.php com backup de estado original
    - Visualizador de debug.log com formata√ß√£o inteligente
    - Destaque visual por tipo de erro (Fatal, Warning, Notice, Deprecated, Parse, DB Error)
    - Formata√ß√£o de stack traces e pretty-print de JSON
    - Fun√ß√£o de limpeza (purge) do arquivo de log
    - Menu na admin bar com acesso r√°pido e status das constantes
    - Contador de entradas de log na admin bar
  - **Estrutura modular**:
    - Nova pasta `includes/` com classes especializadas:
      - `class-dps-debugging-config-transformer.php` - leitura/escrita do wp-config.php
      - `class-dps-debugging-log-viewer.php` - visualiza√ß√£o e parsing do debug.log
      - `class-dps-debugging-admin-bar.php` - integra√ß√£o com admin bar
    - Nova pasta `assets/css/` com `debugging-admin.css` (tema escuro para logs)
  - **Seguran√ßa**:
    - Nonces em todas as a√ß√µes
    - Verifica√ß√£o de capability `manage_options`
    - Valida√ß√£o de permiss√µes de arquivo antes de modificar
    - Confirma√ß√£o JavaScript antes de purge
  - **Filtros expostos**:
    - `dps_debugging_config_path` - customizar caminho do wp-config.php
    - `dps_debugging_admin_bar_cap` - customizar capability para admin bar
  - **Impacto**: Facilita debugging durante desenvolvimento sem necessidade de plugins externos
- **Stats Add-on (v1.1.0)**: Refatora√ß√£o completa com novas funcionalidades
  - **Estrutura modular**:
    - Nova pasta `includes/` com `class-dps-stats-api.php` (API p√∫blica)
    - Nova pasta `assets/css/` com `stats-addon.css` (estilos externos)
    - Nova pasta `assets/js/` com `stats-addon.js` (gr√°ficos Chart.js)
    - Plugin principal refatorado com m√©todos menores e especializados
  - **API p√∫blica DPS_Stats_API**:
    - `get_appointments_count()` - contagem de atendimentos
    - `get_revenue_total()` / `get_expenses_total()` - totais financeiros
    - `get_financial_totals()` - receita e despesas com integra√ß√£o Finance API
    - `get_ticket_average()` - ticket m√©dio calculado
    - `get_cancellation_rate()` - taxa de cancelamento
    - `get_new_clients_count()` - novos clientes no per√≠odo
    - `get_inactive_pets()` - pets inativos com query SQL otimizada
    - `get_top_services()` - servi√ßos mais solicitados
    - `get_species_distribution()` - distribui√ß√£o por esp√©cie
    - `get_top_breeds()` - ra√ßas mais atendidas
    - `get_period_comparison()` - comparativo com per√≠odo anterior (%)
    - `export_metrics_csv()` / `export_inactive_pets_csv()` - exporta√ß√£o CSV
  - **Dashboard visual**:
    - Cards de m√©tricas coloridos com √≠cones
    - Varia√ß√£o percentual vs per√≠odo anterior (verde/vermelho)
    - Se√ß√µes colaps√°veis com `<details>` para organiza√ß√£o
    - Gr√°fico de barras para top servi√ßos (Chart.js)
    - Gr√°fico de pizza para distribui√ß√£o de esp√©cies (Chart.js)
    - Barras horizontais para top ra√ßas
    - Grid responsivo com media queries
  - **Novas m√©tricas**:
    - Ticket m√©dio (receita √∑ atendimentos)
    - Taxa de cancelamento (%)
    - Novos clientes cadastrados no per√≠odo
    - Comparativo autom√°tico com per√≠odo anterior
  - **Exporta√ß√£o CSV**:
    - Bot√£o "Exportar M√©tricas CSV" com todas as m√©tricas
    - Bot√£o "Exportar Inativos CSV" com lista de pets
    - BOM UTF-8 para compatibilidade com Excel
    - Nonces para seguran√ßa
  - **Otimiza√ß√µes**:
    - Query SQL otimizada para pets inativos (GROUP BY em vez de N+1)
    - Integra√ß√£o com Finance API (quando dispon√≠vel)
    - Cache via transients mantido
    - Assets carregados via wp_enqueue_* padr√£o WordPress
  - **Impacto**: Dashboard visual moderno, API para integra√ß√£o, performance melhorada
- **Stats Add-on**: Documento de an√°lise completa do add-on
  - `docs/analysis/STATS_ADDON_ANALYSIS.md` com ~850 linhas de an√°lise detalhada
  - Avalia√ß√£o de funcionalidade, c√≥digo, seguran√ßa, performance e UX (notas 5-8/10)
  - Identifica√ß√£o de 7 problemas de c√≥digo (m√©todo muito grande, queries N+1, dados n√£o exibidos, etc.)
  - Boas pr√°ticas j√° implementadas (cache, nonces, sanitiza√ß√£o, escape, capabilities)
  - Propostas de melhorias: modulariza√ß√£o, API p√∫blica, otimiza√ß√£o de queries, UX visual
  - Mockup de interface melhorada com cards, gr√°ficos e tabelas responsivas
  - Plano de refatora√ß√£o em 5 fases com estimativa de 38-58h de esfor√ßo
  - Sugest√£o de novas funcionalidades: comparativo de per√≠odos, exporta√ß√£o CSV, ticket m√©dio, taxa de reten√ß√£o
  - **Impacto**: Documenta√ß√£o t√©cnica completa para orientar desenvolvimento futuro do dashboard de estat√≠sticas
- **ANALYSIS.md**: Se√ß√£o do Stats Add-on expandida com detalhes de hooks, fun√ß√µes globais, depend√™ncias e transients
- **Services Add-on (v1.3.0)**: Novas funcionalidades de pacotes, hist√≥rico e cat√°logo
  - **Pacotes promocionais com desconto**:
    - Combinar m√∫ltiplos servi√ßos em um pacote
    - Definir desconto percentual (ex: 10% off no combo)
    - Definir pre√ßo fixo alternativo ao desconto
    - M√©todo `DPS_Services_API::calculate_package_price()` para c√°lculo autom√°tico
  - **Hist√≥rico de altera√ß√µes de pre√ßos**:
    - Registro autom√°tico de todas as altera√ß√µes de pre√ßo
    - Armazena data, usu√°rio, pre√ßo antigo e novo
    - M√©todo `DPS_Services_API::get_price_history()` para consulta
    - Mant√©m √∫ltimos 50 registros por servi√ßo
  - **Duplica√ß√£o de servi√ßo**:
    - Bot√£o "Duplicar" na tabela de servi√ßos
    - Copia todos os metadados (pre√ßos, dura√ß√µes, consumo de estoque)
    - Servi√ßo duplicado inicia como inativo (seguran√ßa)
    - M√©todo `DPS_Services_API::duplicate_service()` na API
    - Hook `dps_service_duplicated` disparado ap√≥s duplica√ß√£o
  - **Shortcode de cat√°logo p√∫blico**:
    - `[dps_services_catalog]` para exibir servi√ßos no site
    - Atributos: `show_prices`, `type`, `category`, `layout`
    - Layouts: lista e grid responsivo
    - Agrupa por tipo e categoria automaticamente
    - Destaca pacotes com badge de desconto
  - **API para Portal do Cliente**:
    - M√©todo `get_public_services()` para listar servi√ßos ativos
    - M√©todo `get_portal_services()` com dados para o portal
    - M√©todo `get_client_service_history()` com hist√≥rico de uso
    - M√©todo `get_service_categories()` para categorias dispon√≠veis
  - **Impacto**: Funcionalidades completas de cat√°logo, pacotes e rastreabilidade
- **Services Add-on**: Documento de an√°lise completa do add-on
  - `docs/analysis/SERVICES_ADDON_ANALYSIS.md` com ~850 linhas de an√°lise
  - Avalia√ß√£o de funcionalidade, c√≥digo, seguran√ßa, performance e UX
  - Identifica√ß√£o de vulnerabilidades e propostas de corre√ß√£o
  - Roadmap de melhorias futuras (pacotes, hist√≥rico de pre√ßos, cat√°logo p√∫blico)
  - Estimativas de esfor√ßo para cada melhoria
  - **Impacto**: Documenta√ß√£o t√©cnica para orientar desenvolvimento futuro
- **Groomers Add-on (v1.2.0)**: Edi√ß√£o, exclus√£o de groomers e exporta√ß√£o de relat√≥rios
  - Coluna "A√ß√µes" na tabela de groomers com bot√µes Editar e Excluir
  - Modal de edi√ß√£o de groomer (nome e email)
  - Confirma√ß√£o de exclus√£o com aviso de agendamentos vinculados
  - Bot√£o "Exportar CSV" no relat√≥rio de produtividade
  - Exporta√ß√£o inclui: data, hor√°rio, cliente, pet, status, valor
  - Linha de totais no final do CSV exportado
  - Handlers seguros com nonces para todas as a√ß√µes
  - Valida√ß√£o de role antes de excluir groomer
  - Mensagens de feedback via DPS_Message_Helper
  - CSS para modal responsivo com anima√ß√£o
  - **Impacto**: CRUD completo de groomers e exporta√ß√£o de dados
- **Groomers Add-on (v1.1.0)**: Refatora√ß√£o completa com melhorias de c√≥digo e layout
  - Nova estrutura de assets: pasta `assets/css/` e `assets/js/`
  - Arquivo CSS externo `groomers-admin.css` com ~400 linhas de estilos minimalistas
  - Arquivo JS externo `groomers-admin.js` com valida√ß√µes e interatividade
  - Cards de m√©tricas visuais no relat√≥rio: profissional, atendimentos, receita total, ticket m√©dio
  - Coluna "Pet" adicionada na tabela de resultados do relat√≥rio
  - Formata√ß√£o de data no padr√£o brasileiro (dd/mm/yyyy)
  - Badges de status com cores sem√¢nticas (realizado, pendente, cancelado)
  - Fieldsets no formul√°rio de cadastro: "Dados de Acesso" e "Informa√ß√µes Pessoais"
  - Indicadores de campos obrigat√≥rios (asterisco vermelho)
  - Placeholders descritivos em todos os campos
  - Integra√ß√£o com Finance API para c√°lculo de receitas (com fallback para SQL direto)
  - Novo m√©todo `calculate_total_revenue()` com suporte √† Finance API
  - Documento de an√°lise completa: `docs/analysis/GROOMERS_ADDON_ANALYSIS.md`
  - **Impacto**: Interface mais profissional e consistente com o padr√£o visual DPS
- **GUIA_SISTEMA_DPS.md**: Documento completo de apresenta√ß√£o e configura√ß√£o do sistema
  - Apresenta√ß√£o geral do sistema e arquitetura modular
  - Instru√ß√µes detalhadas de instala√ß√£o do plugin base e add-ons
  - Configura√ß√£o passo a passo de todos os 15 add-ons
  - Guia de uso do sistema (clientes, pets, agendamentos, financeiro)
  - Recursos avan√ßados (assinaturas, fidelidade, WhatsApp)
  - Se√ß√£o de resolu√ß√£o de problemas comuns
  - Refer√™ncia t√©cnica (shortcodes, roles, estrutura de dados)
  - Formatado para publica√ß√£o web (HTML-ready)
  - Instru√ß√µes para manter documento atualizado
  - **Localiza√ß√£o**: `docs/GUIA_SISTEMA_DPS.md`
- **DPS_WhatsApp_Helper**: Classe helper centralizada para gera√ß√£o de links WhatsApp
  - M√©todo `get_link_to_team()` para cliente contatar equipe (usa n√∫mero configurado)
  - M√©todo `get_link_to_client()` para equipe contatar cliente (formata n√∫mero automaticamente)
  - M√©todo `get_share_link()` para compartilhamento gen√©rico (ex: fotos de pets)
  - M√©todo `get_team_phone()` para obter n√∫mero da equipe (configur√°vel ou padr√£o)
  - M√©todos auxiliares para mensagens padr√£o (portal, agendamento, cobran√ßa)
  - Constante padr√£o `TEAM_PHONE = '5515991606299'` (+55 15 99160-6299)
- **Configura√ß√£o de WhatsApp**: Campo "N√∫mero do WhatsApp da Equipe" nas configura√ß√µes de Comunica√ß√µes
  - Option `dps_whatsapp_number` para armazenar n√∫mero da equipe (padr√£o: +55 15 99160-6299)
  - N√∫mero configur√°vel centralmente em Admin ‚Üí DPS by PRObst ‚Üí Comunica√ß√µes
  - Suporte a filtro `dps_team_whatsapp_number` para customiza√ß√£o program√°tica
- **Plugin Base**: Nova op√ß√£o "Agendamento Passado" no formul√°rio de agendamentos
  - Adicionada terceira op√ß√£o de tipo de agendamento para registrar atendimentos j√° realizados
  - Novo fieldset "Informa√ß√µes de Pagamento" com campos espec√≠ficos:
    - Status do Pagamento: dropdown com op√ß√µes "Pago" ou "Pendente"
    - Valor Pendente: campo num√©rico exibido condicionalmente quando status = "Pendente"
  - Campos salvos como metadados: `past_payment_status` e `past_payment_value`
  - Agendamentos passados recebem automaticamente status "realizado"
  - JavaScript atualizado para controlar visibilidade dos campos condicionais
  - TaxiDog e Tosa ocultados automaticamente para agendamentos passados (n√£o aplic√°vel)
  - **Impacto**: Permite registrar no sistema atendimentos realizados anteriormente e controlar pagamentos pendentes
- **Client Portal Add-on (v2.2.0)**: Menu administrativo e tokens permanentes
  - Adicionado menu "Portal do Cliente" sob "DPS by PRObst" com dois submenus:
    - "Portal do Cliente": configura√ß√µes gerais do portal
    - "Logins de Clientes": gerenciamento de tokens de acesso
  - Implementado suporte a tokens permanentes (v√°lidos at√© revoga√ß√£o manual)
  - Modal de sele√ß√£o de tipo de token ao gerar links:
    - "Tempor√°rio (30 minutos)": expira automaticamente ap√≥s 30 minutos
    - "Permanente (at√© revogar)": v√°lido por 10 anos, revog√°vel manualmente
  - Interface atualizada para exibir tipo de token gerado
  - Tokens permanentes facilitam acesso recorrente sem necessidade de gerar novos links
  - **Impacto**: Administradores agora t√™m acesso direto ao gerenciamento do portal via menu WP Admin

#### Changed (Mudado)
- **Groomers Add-on**: Removidos estilos inline, substitu√≠dos por classes CSS
- **Groomers Add-on**: Layout responsivo com flexbox e grid
- **Groomers Add-on**: Formul√°rio reorganizado com fieldsets sem√¢nticos
- **Groomers Add-on**: Tabela de groomers e relat√≥rios com classes CSS customizadas
- **Lista de Clientes**: Atualizada para usar `DPS_WhatsApp_Helper::get_link_to_client()`
- **Add-on de Agenda**: Bot√µes de confirma√ß√£o e cobran√ßa (individual e conjunta) usam helper centralizado
- **Add-on de Agenda (v1.3.1)**: Centraliza√ß√£o de constantes de status
  - Adicionadas constantes `STATUS_PENDING`, `STATUS_FINISHED`, `STATUS_PAID`, `STATUS_CANCELED`
  - Novo m√©todo est√°tico `get_status_config()` retorna configura√ß√£o completa (label, cor, √≠cone)
  - Novo m√©todo est√°tico `get_status_label()` para obter label traduzida de um status
  - Traits refatorados para usar m√©todos centralizados ao inv√©s de strings hardcoded
  - Documenta√ß√£o de melhorias administrativas em `docs/analysis/AGENDA_ADMIN_IMPROVEMENTS_ANALYSIS.md`
- **Add-on de Assinaturas**: Bot√£o de cobran√ßa de renova√ß√£o usa helper centralizado
- **Add-on de Finance**: Bot√£o de cobran√ßa em pend√™ncias financeiras usa helper centralizado
- **Add-on de Stats**: Link de reengajamento para clientes inativos usa helper centralizado
- **Portal do Cliente**: Todos os bot√µes WhatsApp atualizados:
  - Bot√£o "Quero acesso ao meu portal" usa n√∫mero configurado da equipe
  - Envio de link do portal via WhatsApp usa helper para formatar n√∫mero do cliente
  - Bot√£o "Agendar via WhatsApp" (empty state) usa n√∫mero configurado da equipe
  - Bot√£o "Compartilhar via WhatsApp" (fotos de pets) usa helper para compartilhamento
- **Add-on de AI**: Fun√ß√£o JavaScript `openWhatsAppWithMessage` melhorada com coment√°rios
- **Add-on de Comunica√ß√µes**: Interface reorganizada com se√ß√µes separadas para WhatsApp, E-mail e Templates
- **Services Add-on**: Melhorias de UX na interface de servi√ßos
  - Mensagens de feedback (sucesso/erro) via `DPS_Message_Helper` em todas as a√ß√µes
  - Badges de status visual (Ativo/Inativo) na tabela de servi√ßos
  - Tabela de servi√ßos com classes CSS dedicadas para melhor responsividade
  - Wrapper responsivo na tabela com scroll horizontal em mobile
  - Estilos CSS expandidos (~100 linhas adicionadas) para formul√°rio e tabela

#### Fixed (Corrigido)
- **Finance Add-on (v1.3.1)**: Corrigida p√°gina de Documentos Financeiros em branco e vulnerabilidade CSRF
  - **Bug #1 - P√°gina sem shortcode**: Quando p√°gina "Documentos Financeiros" j√° existia com slug `dps-documentos-financeiros`, o m√©todo `activate()` apenas atualizava option mas n√£o verificava/atualizava conte√∫do da p√°gina
    - **Sintoma**: P√°gina aparecia em branco se foi criada manualmente ou teve conte√∫do removido
    - **Solu√ß√£o**: Adicionada verifica√ß√£o em `activate()` para garantir que p√°gina existente sempre tenha shortcode `[dps_fin_docs]`
    - **Impacto**: P√°gina de documentos sempre funcional mesmo ap√≥s modifica√ß√µes manuais
  - **Bug #2 - Falta de controle de acesso**: Shortcode `render_fin_docs_shortcode()` n√£o verificava permiss√µes
    - **Sintoma**: Qualquer visitante poderia acessar lista de documentos financeiros sens√≠veis
    - **Solu√ß√£o**: Adicionada verifica√ß√£o `current_user_can('manage_options')` com filtro `dps_finance_docs_allow_public` para flexibilidade
    - **Impacto**: Documentos agora requerem autentica√ß√£o e permiss√£o administrativa por padr√£o
  - **Bug #3 - CSRF em a√ß√µes de documentos (CR√çTICO)**: A√ß√µes `dps_send_doc` e `dps_delete_doc` n√£o verificavam nonce
    - **Vulnerabilidade**: CSRF permitindo atacante for√ßar usu√°rio autenticado a enviar/deletar documentos
    - **Solu√ß√£o**: Adicionada verifica√ß√£o de nonce em ambas as a√ß√µes; links atualizados para usar `wp_nonce_url()` com nonces √∫nicos por arquivo
    - **Impacto**: Eliminada vulnerabilidade CSRF cr√≠tica; a√ß√µes de documentos agora protegidas contra ataques
  - **Melhoria de UX**: Listagem de documentos convertida de `<ul>` para tabela estruturada
    - Novas colunas: Documento, Cliente, Data, Valor, A√ß√µes
    - Informa√ß√µes extra√≠das automaticamente da transa√ß√£o vinculada
    - Formata√ß√£o adequada de datas e valores monet√°rios
    - **Impacto**: Interface mais profissional e informativa; documentos identific√°veis sem precisar abri-los
  - **An√°lise completa**: Documento detalhado criado em `docs/review/finance-addon-analysis-2025-12-06.md` com 10 sugest√µes de melhorias futuras
- **AI Add-on (v1.6.0)**: Corrigido shortcode `[dps_ai_public_chat]` aparecendo como texto plano
  - **Problema**: Shortcode nunca era registrado, aparecendo como texto plano nas p√°ginas
  - **Causa**: `init_components()` estava registrado no hook `plugins_loaded` (prioridade 21), mas `DPS_AI_Addon` s√≥ era inicializado no hook `init` (prioridade 5). Como `plugins_loaded` executa ANTES de `init`, o hook nunca era chamado.
  - **Solu√ß√£o**: 
    1. Alterado hook de `init_components()` e `init_portal_integration()` de `plugins_loaded` para `init`
    2. Removido m√©todo intermedi√°rio `register_shortcode()` e chamado `add_shortcode()` diretamente no construtor
  - **Impacto**: Shortcode agora renderiza corretamente o chat p√∫blico quando inserido em p√°ginas/posts
- **Compatibilidade WordPress 6.2+**: Substitu√≠da fun√ß√£o deprecada `get_page_by_title()` por `dps_get_page_by_title_compat()` no Portal do Cliente. A nova fun√ß√£o usa `WP_Query` conforme recomenda√ß√£o oficial do WordPress, garantindo compatibilidade com WordPress 6.9+
- **Plugin Base**: Corrigido bot√µes "Selecionar todos" e "Desmarcar todos" na sele√ß√£o de pets
  - O handler de toggle de pets usava `.data('owner')` que l√™ do cache interno do jQuery
  - Ap√≥s PR #165, `buildPetOption` passou a usar `.attr()` para definir atributos DOM
  - O handler de toggle n√£o foi atualizado junto, causando inconsist√™ncia
  - **Corrigido**: Alterado handler para usar `.attr('data-owner')` ao inv√©s de `.data('owner')`
  - **Impacto**: Bot√µes de sele√ß√£o/desmarcar todos os pets agora funcionam corretamente
- **Groomers Add-on**: Corrigido `uninstall.php` para usar meta key correta `_dps_groomers`
  - Problema: arquivo tentava deletar meta keys incorretas (`appointment_groomer_id`, `appointment_groomers`)
  - Meta key correta √© `_dps_groomers` (array de IDs de groomers)
  - **Impacto**: Desinstala√ß√£o do add-on agora remove corretamente os metadados
- **Plugin Base**: Corrigido seletor de pets n√£o exibir pets ao selecionar cliente no formul√°rio de agendamentos
  - A fun√ß√£o `buildPetOption` usava `$('<label/>', { 'data-owner': ... })` que armazena dados no cache interno do jQuery
  - A fun√ß√£o `applyPetFilters` usava `.attr('data-owner')` para ler, que busca no atributo DOM (sempre vazio)
  - **Corrigido**: Alterado para usar `.attr()` para definir `data-owner` e `data-search`, garantindo consist√™ncia
  - **Impacto**: Pets do cliente selecionado agora aparecem corretamente na lista de sele√ß√£o de pets
- **Plugin Base**: Corrigido aviso PHP `map_meta_cap was called incorrectly` no WordPress 6.1+
  - Adicionadas capabilities de exclus√£o faltantes (`delete_posts`, `delete_private_posts`, `delete_published_posts`, `delete_others_posts`) nos CPTs:
    - `dps_cliente` (Clientes)
    - `dps_pet` (Pets)
    - `dps_agendamento` (Agendamentos)
  - **Corrigido**: Notices repetidos no error log sobre `delete_post` capability sem post espec√≠fico
  - **Impacto**: Elimina avisos no log ao excluir ou gerenciar posts dos CPTs personalizados
- **Plugin Base**: Corrigido aviso PHP `Undefined variable $initial_pending_rows`
  - Inicializada vari√°vel como array vazio antes de uso condicional
  - **Corrigido**: Notice na linha 1261 de class-dps-base-frontend.php
  - **Impacto**: Elimina aviso no error log ao carregar formul√°rio de agendamentos
- **Stock Add-on**: Adicionadas capabilities de exclus√£o faltantes (`delete_private_posts`, `delete_published_posts`)
  - Complementa capabilities j√° existentes para total compatibilidade com `map_meta_cap`
- N√∫mero da equipe agora √© configur√°vel e centralizado (antes estava hardcoded em v√°rios locais)
- Formata√ß√£o de n√∫meros de telefone padronizada em todo o sistema usando `DPS_Phone_Helper`
- Portal do Cliente agora usa n√∫mero da equipe configurado ao inv√©s de placeholder `5551999999999`
- Todos os links WhatsApp agora formatam n√∫meros de clientes corretamente (adicionam c√≥digo do pa√≠s automaticamente)
- **AI Add-on & Client Portal Add-on**: Corrigido assistente virtual no Portal do Cliente
  - Adicionado m√©todo p√∫blico `get_current_client_id()` na classe `DPS_Client_Portal` para permitir acesso externo ao ID do cliente autenticado
  - Criado novo hook `dps_client_portal_before_content` que dispara ap√≥s a navega√ß√£o e antes das se√ß√µes de conte√∫do
  - Movido widget do assistente virtual de `dps_client_portal_after_content` para `dps_client_portal_before_content`
  - **Corrigido**: Erro "Voc√™ precisa estar logado para usar o assistente" ao acessar portal via link de acesso
  - **Corrigido**: Posicionamento do assistente agora √© no topo da p√°gina (ap√≥s navega√ß√£o), conforme especifica√ß√£o
  - **Impacto**: Assistente virtual agora funciona corretamente quando cliente acessa via token/link permanente
- **Services Add-on & Loyalty Add-on (WordPress 6.7+)**: Corrigido carregamento de tradu√ß√µes antes do hook 'init'
  - Movido carregamento de text domain para hook 'init' com prioridade 1 (anteriormente prioridade padr√£o 10)
  - Movida instancia√ß√£o de classes para hook 'init' com prioridade 5:
    - Services Add-on: de escopo global para `init` priority 5
    - Loyalty Add-on: de hook `plugins_loaded` para `init` priority 5
  - Ordem de execu√ß√£o garantida: (1) text domain carrega em init:1, (2) classe instancia em init:5, (3) CPT registra em init:10
  - **Corrigido**: PHP Notice "Translation loading for the domain was triggered too early" no WordPress 6.7.0+
  - **Documentado**: Padr√£o de carregamento de text domains no ANALYSIS.md se√ß√£o "Text Domains para Internacionaliza√ß√£o"
- **Loyalty Add-on**: Corrigido erro de capability check ao atribuir pontos
  - Adicionada verifica√ß√£o se o post existe antes de chamar `get_post_type()`
  - **Corrigido**: Notice "map_meta_cap was called incorrectly" ao verificar capability `delete_post`
  - Previne erro quando WordPress verifica capabilities internamente durante mudan√ßa de status de agendamento
- **Plugin Base**: Corrigido acesso ao painel de gest√£o para usu√°rios com role `dps_reception`
  - Fun√ß√£o `can_manage()` agora aceita `manage_options` OU qualquer capability DPS espec√≠fica (`dps_manage_clients`, `dps_manage_pets`, `dps_manage_appointments`)
  - Removida verifica√ß√£o duplicada de `manage_options` no m√©todo `handle_request()` que bloqueava usu√°rios sem permiss√£o de administrador
  - Usu√°rios com capabilities DPS espec√≠ficas agora podem acessar o painel e executar a√ß√µes permitidas
  - **Corrigido**: Pets vinculados ao cliente n√£o apareciam ao selecionar cliente (causado pelo bloqueio de acesso ao painel)
  - **Corrigido**: Erro "Acesso negado" ao alterar status de agendamento (causado pela verifica√ß√£o duplicada de permiss√µes)
  - Atualizada mensagem de erro de login para refletir que n√£o apenas administradores podem acessar
  - Adicionada documenta√ß√£o explicando modelo de permiss√µes: painel vis√≠vel para qualquer capability DPS, mas a√ß√µes protegidas individualmente
- **Menus Administrativos**: Corrigido registro de menus em add-ons
  - Backup Add-on: submenu agora aparece corretamente sob "DPS by PRObst" (corrigida ordem de carregamento)
  - Loyalty Add-on: menus agora aparecem sob "DPS by PRObst" em vez de criar menu pr√≥prio separado
  - Logs do Sistema: migrado de menu separado para submenu sob "DPS by PRObst" (melhor organiza√ß√£o)
  - Mensagens do Portal: migrado de menu separado para submenu sob "DPS by PRObst" (CPT com show_in_menu)
  - Cadastro P√∫blico renomeado para "Formul√°rio de Cadastro" (nome mais intuitivo)
  - Todos os add-ons com menus agora usam prioridade 20 no hook `admin_menu` para garantir que o menu pai j√° existe
  - Estrutura de menus documentada em `ANALYSIS.md` na se√ß√£o "Estrutura de Menus Administrativos"
  - Adicionadas diretrizes de nomenclatura para melhorar usabilidade (nomes descritivos, sem prefixos redundantes)
  - **Impacto**: Todos os menus e submenus agora est√£o agrupados no mesmo menu principal "DPS by PRObst" para facilitar gerenciamento
- **Formul√°rio de Agendamentos**: Melhorias de responsividade para telas pequenas
  - Corrigido overflow horizontal em mobile e tablet (adicionado `overflow-x: hidden` em `.dps-form`)
  - Ajustado tamanho de inputs e selects para mobile (`padding: 8px` em ‚â§768px, `10px 8px` em ‚â§480px)
  - Inclu√≠dos todos os tipos de input (date, time, number) nas regras de font-size mobile (16px para evitar zoom iOS)
  - Adicionado wrapper `.dps-form-field` com margin-bottom consistente (12px)
  - Reduzido padding de fieldsets em mobile pequeno (12px em ‚â§480px)
  - Ajustado card de resumo para telas pequenas:
    - Labels strong: `min-width: 100px` (era 140px) em ‚â§480px
    - Font-size reduzido para 13px (itens) e 16px (t√≠tulo H3)
  - Reduzido tamanho da legend em telas muito pequenas (15px em ‚â§480px)
- **Finance Add-on**: Corrigido fatal error ao renderizar mensagens de feedback
  - **Problema**: Chamada a m√©todo inexistente `DPS_Message_Helper::render()` causava fatal error na linha 1725
  - **Causa**: Finance add-on tentava usar m√©todo `render()` que n√£o existe na classe `DPS_Message_Helper`
  - **Solu√ß√£o**: Substitu√≠da chamada por renderiza√ß√£o inline usando a mesma estrutura HTML do m√©todo `display_messages()`
  - **Impacto**: Mensagens de feedback (sucesso/erro) agora s√£o exibidas corretamente na se√ß√£o financeira sem causar erros

#### Security (Seguran√ßa)
- **Finance Add-on (v1.3.1)**: Corrigida vulnerabilidade CSRF cr√≠tica em a√ß√µes de documentos
  - **Vulnerabilidade**: A√ß√µes `dps_send_doc` e `dps_delete_doc` n√£o verificavam nonce, permitindo CSRF
  - **Impacto potencial**: Atacante poderia for√ßar administrador autenticado a:
    - Enviar documentos financeiros sens√≠veis para emails maliciosos
    - Deletar documentos importantes sem autoriza√ß√£o
    - Executar a√ß√µes n√£o autorizadas em documentos
  - **Solu√ß√£o**: Adicionada verifica√ß√£o de nonce √∫nica por arquivo em ambas as a√ß√µes
  - **Prote√ß√£o adicional**: Controle de acesso via `current_user_can('manage_options')` no shortcode
  - **Severidade**: CR√çTICA - eliminada completamente com as corre√ß√µes implementadas
- **Services Add-on**: Corrigidas vulnerabilidades CSRF cr√≠ticas
  - Adicionada verifica√ß√£o de nonce em exclus√£o de servi√ßo (`dps_delete_service_{id}`)
  - Adicionada verifica√ß√£o de nonce em toggle de status (`dps_toggle_service_{id}`)
  - Adicionada verifica√ß√£o de post_type antes de excluir/modificar
  - URLs de a√ß√£o agora usam `wp_nonce_url()` para prote√ß√£o autom√°tica
  - **Impacto**: Elimina possibilidade de exclus√£o/altera√ß√£o de servi√ßos via links maliciosos
- Todas as URLs de WhatsApp usam `esc_url()` para escape adequado
- Mensagens de WhatsApp usam `rawurlencode()` para encoding seguro de caracteres especiais
- N√∫meros de telefone s√£o sanitizados via `sanitize_text_field()` antes de salvar configura√ß√£o
- Helper `DPS_WhatsApp_Helper` implementa valida√ß√£o de entrada para prevenir links malformados

#### Documentation (Documenta√ß√£o)
- **ANALYSIS.md**: Atualizada se√ß√£o "Portal do Cliente" com novos hooks, fun√ß√µes helper e vers√£o 2.1.0
- **Client Portal README.md**: Atualizada se√ß√£o "Para administradores" com instru√ß√µes de configura√ß√£o da p√°gina do portal

#### Added (Adicionado)
- **Client Portal Add-on (v2.1.0)**: Interface de configura√ß√µes para gerenciamento do Portal do Cliente
  - Nova aba "Portal" nas configura√ß√µes do sistema para configurar p√°gina do portal
  - Campo de sele√ß√£o (dropdown) para escolher a p√°gina onde o shortcode `[dps_client_portal]` est√° inserido
  - Exibi√ß√£o do link do portal com bot√£o "Copiar Link" para facilitar compartilhamento
  - Instru√ß√µes de uso do portal com passos detalhados
  - Salvamento de configura√ß√µes via option `dps_portal_page_id` com valida√ß√£o de nonce
  - Fun√ß√µes helper globais `dps_get_portal_page_url()` e `dps_get_portal_page_id()` para obter URL/ID do portal
  - Fallback autom√°tico para p√°gina com t√≠tulo "Portal do Cliente" (compatibilidade com vers√µes anteriores)
  - Template `templates/portal-settings.php` com estilos minimalistas DPS
  - Script inline para copiar URL do portal com feedback visual
- **Payment Add-on**: Documenta√ß√£o completa de configura√ß√£o do webhook secret
  - Novo arquivo `WEBHOOK_CONFIGURATION.md` com guia passo a passo completo
  - Instru√ß√µes detalhadas sobre gera√ß√£o de senha forte, configura√ß√£o no DPS e no Mercado Pago
  - Exemplos de URLs de webhook com os 4 m√©todos suportados (query parameter, headers)
  - Se√ß√£o de troubleshooting com erros comuns e solu√ß√µes
  - Se√ß√£o de valida√ß√£o e testes com exemplos de logs
  - FAQ com perguntas frequentes sobre seguran√ßa e configura√ß√£o
- **Internacionaliza√ß√£o (i18n)**: Documenta√ß√£o de text domains oficiais em ANALYSIS.md para facilitar tradu√ß√£o
- **Client Portal Add-on (v2.0.0)**: Sistema completo de autentica√ß√£o por token (magic links)
  - **BREAKING CHANGE**: Substitu√≠do sistema de login com senha por autentica√ß√£o via links com token
  - Nova tabela `wp_dps_portal_tokens` para gerenciar tokens de acesso
  - Classe `DPS_Portal_Token_Manager` para gera√ß√£o, valida√ß√£o e revoga√ß√£o de tokens
  - Classe `DPS_Portal_Session_Manager` para gerenciar sess√µes independentes do WordPress
  - Classe `DPS_Portal_Admin_Actions` para processar a√ß√µes administrativas
  - Tokens seguros de 64 caracteres com hash (password_hash/password_verify)
  - Expira√ß√£o configur√°vel (padr√£o 30 minutos)
  - Marca√ß√£o de uso (single use)
  - Cleanup autom√°tico via cron job (tokens > 30 dias)
  - Tela de acesso p√∫blica minimalista (`templates/portal-access.php`)
  - Interface administrativa completa de gerenciamento (`templates/admin-logins.php`)
  - Tabela responsiva de clientes com status de acesso e √∫ltimo login
  - Bot√µes "Primeiro Acesso" e "Gerar Novo Link"
  - Bot√£o "Revogar" para invalidar tokens ativos
  - Exibi√ß√£o tempor√°ria de links gerados (5 minutos)
  - Integra√ß√£o com WhatsApp: abre WhatsApp Web com mensagem pronta
  - Integra√ß√£o com E-mail: modal de pr√©-visualiza√ß√£o obrigat√≥ria antes de enviar
  - JavaScript para copiar links, modais e AJAX (`assets/js/portal-admin.js`)
  - Busca de clientes por nome ou telefone
  - Feedback visual para todas as a√ß√µes
  - Compatibilidade com sistema antigo mantida (fallback)
  - Documenta√ß√£o em `templates/portal-access.php` e `templates/admin-logins.php`
- **AI Add-on (v1.1.0)**: Campo de "Instru√ß√µes adicionais" nas configura√ß√µes da IA
  - Permite administrador complementar comportamento da IA sem substituir regras base de seguran√ßa
  - Campo opcional com limite de 2000 caracteres
  - Instru√ß√µes adicionais s√£o enviadas como segunda mensagem de sistema ap√≥s prompt base
  - Prompt base protegido contra contradi√ß√µes posteriores
  - Novo m√©todo p√∫blico `DPS_AI_Assistant::get_base_system_prompt()` para reutiliza√ß√£o
- **AI Add-on (v1.2.0)**: Assistente de IA para Comunica√ß√µes
  - Nova classe `DPS_AI_Message_Assistant` para gerar sugest√µes de mensagens
  - `DPS_AI_Message_Assistant::suggest_whatsapp_message($context)` - Gera sugest√£o de mensagem para WhatsApp
  - `DPS_AI_Message_Assistant::suggest_email_message($context)` - Gera sugest√£o de e-mail (assunto e corpo)
  - Handlers AJAX `wp_ajax_dps_ai_suggest_whatsapp_message` e `wp_ajax_dps_ai_suggest_email_message`
  - Interface JavaScript com bot√µes de sugest√£o e modal de pr√©-visualiza√ß√£o para e-mails
  - Suporta 6 tipos de mensagens: lembrete, confirma√ß√£o, p√≥s-atendimento, cobran√ßa suave, cancelamento, reagendamento
  - **IMPORTANTE**: IA NUNCA envia automaticamente - apenas gera sugest√µes que o usu√°rio revisa antes de enviar
  - Documenta√ß√£o completa em `add-ons/desi-pet-shower-ai_addon/AI_COMMUNICATIONS.md`
  - Exemplos de integra√ß√£o em `add-ons/desi-pet-shower-ai_addon/includes/ai-communications-examples.php`
- **Services Add-on**: Nova API p√∫blica (`DPS_Services_API`) para centralizar l√≥gica de servi√ßos e c√°lculo de pre√ßos (v1.2.0)
  - `DPS_Services_API::get_service($service_id)` - Retornar dados completos de um servi√ßo
  - `DPS_Services_API::calculate_price($service_id, $pet_size, $context)` - Calcular pre√ßo por porte do pet
  - `DPS_Services_API::calculate_appointment_total($services_ids, $pets_ids, $context)` - Calcular total de agendamento
  - `DPS_Services_API::get_services_details($appointment_id)` - Retornar detalhes dos servi√ßos de um agendamento
- **Services Add-on**: Endpoint AJAX `dps_get_services_details` movido da Agenda para Services (mant√©m compatibilidade)
- **Finance Add-on**: Nova API financeira p√∫blica (`DPS_Finance_API`) para centralizar opera√ß√µes de cobran√ßas
  - `DPS_Finance_API::create_or_update_charge()` - Criar ou atualizar cobran√ßa vinculada a agendamento
  - `DPS_Finance_API::mark_as_paid()` - Marcar cobran√ßa como paga
  - `DPS_Finance_API::mark_as_pending()` - Reabrir cobran√ßa como pendente
  - `DPS_Finance_API::mark_as_cancelled()` - Cancelar cobran√ßa
  - `DPS_Finance_API::get_charge()` - Buscar dados de uma cobran√ßa
  - `DPS_Finance_API::get_charges_by_appointment()` - Buscar todas as cobran√ßas de um agendamento
  - `DPS_Finance_API::delete_charges_by_appointment()` - Remover cobran√ßas ao excluir agendamento
  - `DPS_Finance_API::validate_charge_data()` - Validar dados antes de criar/atualizar
- **Finance Add-on**: Novos hooks para integra√ß√£o:
  - `dps_finance_charge_created` - Disparado ao criar nova cobran√ßa
  - `dps_finance_charge_updated` - Disparado ao atualizar cobran√ßa existente
  - `dps_finance_charges_deleted` - Disparado ao deletar cobran√ßas de um agendamento
- **Agenda Add-on**: Verifica√ß√£o de depend√™ncia do Finance Add-on com aviso no admin
- **Documenta√ß√£o**: `FINANCE_AGENDA_REORGANIZATION_DIAGNOSTIC.md` - Diagn√≥stico completo da reorganiza√ß√£o arquitetural (33KB, 7 se√ß√µes)
- Criadas classes helper para melhorar qualidade e manutenibilidade do c√≥digo:
  - `DPS_Money_Helper`: manipula√ß√£o consistente de valores monet√°rios, convers√£o formato brasileiro ‚Üî centavos
  - `DPS_URL_Builder`: constru√ß√£o padronizada de URLs de edi√ß√£o, exclus√£o, visualiza√ß√£o e navega√ß√£o
  - `DPS_Query_Helper`: consultas WP_Query reutiliz√°veis com filtros comuns e pagina√ß√£o
  - `DPS_Request_Validator`: valida√ß√£o centralizada de nonces, capabilities e sanitiza√ß√£o de campos
- Criada classe `DPS_Message_Helper` para feedback visual consistente:
  - Mensagens de sucesso, erro e aviso via transients espec√≠ficos por usu√°rio
  - Exibi√ß√£o autom√°tica no topo das se√ß√µes com remo√ß√£o ap√≥s visualiza√ß√£o
  - Integrada em todos os fluxos de salvamento e exclus√£o (clientes, pets, agendamentos)
- Adicionado documento de an√°lise de refatora√ß√£o (`docs/refactoring/REFACTORING_ANALYSIS.md`) com identifica√ß√£o detalhada de problemas de c√≥digo e sugest√µes de melhoria
- Criado arquivo de exemplos pr√°ticos (`includes/refactoring-examples.php`) demonstrando uso das classes helper e padr√µes de refatora√ß√£o
- Implementado `register_deactivation_hook` no add-on Agenda para limpar cron job `dps_agenda_send_reminders` ao desativar
- Adicionada se√ß√£o completa de "Padr√µes de desenvolvimento de add-ons" no `ANALYSIS.md` incluindo:
  - Estrutura de arquivos recomendada com separa√ß√£o de responsabilidades
  - Guia de uso correto de activation/deactivation hooks
  - Padr√µes de documenta√ß√£o com DocBlocks seguindo conven√ß√µes WordPress
  - Boas pr√°ticas de prefixa√ß√£o, seguran√ßa, performance e integra√ß√£o
- Criados documentos de an√°lise e guias de estilo:
  - `docs/visual/VISUAL_STYLE_GUIDE.md`: guia completo de cores, tipografia, componentes e √≠cones (450+ linhas)
  - `docs/layout/admin/ADMIN_LAYOUT_ANALYSIS.md`: an√°lise detalhada de usabilidade das telas administrativas (600+ linhas)
  - `docs/implementation/UI_UX_IMPROVEMENTS_SUMMARY.md`: resumo executivo de melhorias implementadas
- **AI Add-on**: Novo add-on de Assistente Virtual para Portal do Cliente (v1.0.0)
  - Assistente focado EXCLUSIVAMENTE em Banho e Tosa, servi√ßos, agendamentos, hist√≥rico e funcionalidades do DPS
  - Integra√ß√£o com OpenAI Chat Completions API (GPT-3.5 Turbo / GPT-4 / GPT-4 Turbo)
  - System prompt restritivo que pro√≠be conversas sobre pol√≠tica, religi√£o, tecnologia e outros assuntos fora do contexto
  - Filtro preventivo de palavras-chave antes de chamar API (economiza custos e protege contexto)
  - Widget de chat responsivo no Portal do Cliente com estilos minimalistas DPS
  - Contexto autom√°tico incluindo dados do cliente/pet, agendamentos recentes, pend√™ncias financeiras e pontos de fidelidade
  - Endpoint AJAX `dps_ai_portal_ask` com valida√ß√£o de nonce e cliente logado
  - Interface administrativa para configura√ß√£o (API key, modelo, temperatura, timeout, max_tokens)
  - Sistema autocontido: falhas n√£o afetam funcionamento do Portal
  - Documenta√ß√£o completa em `add-ons/desi-pet-shower-ai_addon/README.md`
- **Client Portal Add-on**: Novo hook `dps_client_portal_after_content` para permitir add-ons adicionarem conte√∫do ao final do portal (usado pelo AI Add-on)
  - `docs/layout/admin/ADMIN_LAYOUT_ANALYSIS.md`: an√°lise detalhada de usabilidade e layout das telas administrativas
  - `docs/visual/VISUAL_STYLE_GUIDE.md`: guia oficial de estilo visual minimalista
  - `docs/implementation/UI_UX_IMPROVEMENTS_SUMMARY.md`: resumo das melhorias implementadas
  - `docs/layout/forms/FORMS_UX_ANALYSIS.md`: an√°lise completa de UX dos formul√°rios de cadastro com prioriza√ß√£o de melhorias
- **Agenda Add-on**: Implementadas melhorias de FASE 1 e FASE 2:
  - Bot√£o "‚ûï Novo Agendamento" adicionado √† barra de navega√ß√£o para workflow completo
  - Modal customizado para visualiza√ß√£o de servi√ßos (substitui alert() nativo)
  - √çcones e tooltips em links de a√ß√£o (üìç Mapa, üí¨ Confirmar, üí∞ Cobrar)
  - Flag de pet agressivo melhorada (‚ö†Ô∏è com tooltip "Pet agressivo - cuidado no manejo")
  - Criados arquivos de assets: `assets/css/agenda-addon.css` e `assets/js/services-modal.js`
- **Formul√°rios de cadastro**: Sistema completo de grid responsivo e componentes visuais:
  - Classes CSS para grid: `.dps-form-row`, `.dps-form-row--2col`, `.dps-form-row--3col`
  - Asterisco vermelho para campos obrigat√≥rios: `.dps-required`
  - Checkbox melhorado: `.dps-checkbox-label`, `.dps-checkbox-text`
  - Upload de arquivo estilizado: `.dps-file-upload` com border dashed e hover
  - Preview de imagem antes do upload via JavaScript (FileReader API)
  - Desabilita√ß√£o autom√°tica de bot√£o submit durante salvamento (previne duplicatas)

#### Changed (Alterado)
- **Client Portal Add-on**: Refatora√ß√£o de 7 ocorr√™ncias de `get_page_by_title('Portal do Cliente')` hardcoded
  - Substitu√≠do por chamadas √†s fun√ß√µes helper centralizadas `dps_get_portal_page_url()` e `dps_get_portal_page_id()`
  - Modificados: `class-dps-client-portal.php` (4x), `class-dps-portal-session-manager.php` (2x), `class-dps-portal-token-manager.php` (1x)
  - Mantido comportamento legado como fallback dentro das fun√ß√µes helper
- **Payment Add-on**: Campo "Webhook secret" nas configura√ß√µes melhorado com instru√ß√µes inline
  - Descri√ß√£o expandida com passos numerados de configura√ß√£o
  - Exemplo de URL do webhook com dom√≠nio real do site
  - Link para guia completo de configura√ß√£o (abre em nova aba)
  - Destaque visual para facilitar compreens√£o da configura√ß√£o obrigat√≥ria
- **Payment Add-on README.md**: Se√ß√£o de configura√ß√£o atualizada com destaque para webhook secret
  - Aviso destacado sobre obrigatoriedade do webhook secret no topo do documento
  - Link proeminente para guia de configura√ß√£o em m√∫ltiplas se√ß√µes
  - Fluxo autom√°tico atualizado com passo de valida√ß√£o do webhook secret
- **ANALYSIS.md**: Documenta√ß√£o do Payment Add-on atualizada
  - Option `dps_mercadopago_webhook_secret` adicionada √† lista de op√ß√µes armazenadas
  - Refer√™ncia ao guia de configura√ß√£o completo em observa√ß√µes do add-on
- **Communications Add-on v0.2.0**: Arquitetura completamente reorganizada
  - Toda l√≥gica de envio centralizada em `DPS_Communications_API`
  - Templates de mensagens com suporte a placeholders (`{client_name}`, `{pet_name}`, `{date}`, `{time}`)
  - Logs autom√°ticos de envios via `DPS_Logger` (n√≠veis INFO/ERROR/WARNING)
  - Fun√ß√µes legadas `dps_comm_send_whatsapp()` e `dps_comm_send_email()` agora delegam para API (deprecated)
- **Agenda Add-on**: Comunica√ß√µes delegadas para Communications API
  - Envio de lembretes di√°rios via `DPS_Communications_API::send_appointment_reminder()`
  - Notifica√ß√µes de status (finalizado/finalizado_pago) via `DPS_Communications_API::send_whatsapp()`
  - M√©todo `format_whatsapp_number()` agora delega para `DPS_Phone_Helper` (deprecated)
  - **Mantidos**: bot√µes de confirma√ß√£o e cobran√ßa via links wa.me (n√£o s√£o envios autom√°ticos)
- **Client Portal Add-on**: Mensagens de clientes delegadas para Communications API
  - Envio de mensagens do Portal via `DPS_Communications_API::send_message_from_client()`
  - Fallback para `wp_mail()` direto se API n√£o estiver dispon√≠vel (compatibilidade retroativa)
- **Agenda Add-on**: Agora depende do Finance Add-on para funcionalidade completa de cobran√ßas
- **Agenda Add-on**: Removida l√≥gica financeira duplicada (~55 linhas de SQL direto)
- **Agenda Add-on**: `update_status_ajax()` agora confia na sincroniza√ß√£o autom√°tica do Finance via hooks
- **Finance Add-on**: `cleanup_transactions_for_appointment()` agora delega para `DPS_Finance_API`
- **Finance Add-on**: Fun√ß√µes `dps_parse_money_br()` e `dps_format_money_br()` agora delegam para `DPS_Money_Helper` do n√∫cleo
- **Loyalty Add-on**: Fun√ß√£o `dps_format_money_br()` agora delega para `DPS_Money_Helper` do n√∫cleo
- Interface administrativa completamente reformulada com design minimalista:
  - Paleta de cores reduzida e consistente (base neutra + 3 cores de status essenciais)
  - Remo√ß√£o de sombras decorativas e elementos visuais desnecess√°rios
  - Alertas simplificados com borda lateral colorida (sem pseudo-elementos ou fundos vibrantes)
  - Cores de status em tabelas mais suaves (amarelo claro, verde claro, cinza neutro, opacidade para cancelados)
- Hierarquia sem√¢ntica corrigida em todas as telas do painel:
  - H1 √∫nico no topo do painel ("Painel de Gest√£o DPS")
  - H2 para se√ß√µes principais (Cadastro de Clientes, Cadastro de Pets, etc.)
  - H3 para subse√ß√µes e listagens com separa√ß√£o visual (borda superior + padding)
- Formul√°rios reorganizados com agrupamento l√≥gico de campos:
  - Formul√°rio de clientes dividido em 4 fieldsets: Dados Pessoais, Contato, Redes Sociais, Endere√ßo e Prefer√™ncias
  - Bordas sutis (#e5e7eb) e legends descritivos para cada grupo
  - Redu√ß√£o de sobrecarga cognitiva atrav√©s de organiza√ß√£o visual clara
- **Formul√°rio de Pet (Admin) completamente reestruturado**:
  - Dividido em 4 fieldsets tem√°ticos (antes eram 17+ campos soltos):
    1. **Dados B√°sicos**: Nome, Cliente, Esp√©cie, Ra√ßa, Sexo (grid 2col e 3col)
    2. **Caracter√≠sticas F√≠sicas**: Tamanho, Peso, Data nascimento, Tipo de pelo, Cor (grid 3col e 2col)
    3. **Sa√∫de e Comportamento**: Vacinas, Alergias, Cuidados, Notas, Checkbox "C√£o agressivo ‚ö†Ô∏è"
    4. **Foto do Pet**: Upload estilizado com preview
  - Labels melhorados: "Pelagem" ‚Üí "Tipo de pelo", "Porte" ‚Üí "Tamanho", "Cor" ‚Üí "Cor predominante"
  - Peso com valida√ß√£o HTML5: `min="0.1" max="100" step="0.1"`
  - Placeholders descritivos em todos os campos (ex.: "Curto, longo, encaracolado...", "Branco, preto, caramelo...")
- **Formul√°rio de Cliente (Admin)** aprimorado:
  - Grid 2 colunas para campos relacionados: CPF + Data nascimento, Instagram + Facebook
  - Placeholders padronizados: CPF "000.000.000-00", Telefone "(00) 00000-0000", Email "seuemail@exemplo.com"
  - Asteriscos (*) em campos obrigat√≥rios (Nome, Telefone)
  - Input `tel` para telefone em vez de `text` gen√©rico
  - Checkbox de autoriza√ß√£o de foto com layout melhorado (`.dps-checkbox-label`)
- **Portal do Cliente**: Formul√°rios alinhados ao padr√£o minimalista:
  - Grid responsivo em formul√°rios de cliente e pet (2-3 colunas em desktop ‚Üí 1 coluna em mobile)
  - Placeholders em todos os campos (Telefone, Email, Endere√ßo, Instagram, Facebook, campos do pet)
  - Labels consistentes: "Pelagem" ‚Üí "Tipo de pelo", "Porte" ‚Üí "Tamanho"
  - Upload de foto estilizado com `.dps-file-upload` e preview JavaScript
  - Bot√µes submit com classe `.dps-submit-btn` (largura 100% em mobile)
- Responsividade b√°sica implementada para dispositivos m√≥veis:
  - Tabelas com scroll horizontal em telas <768px
  - Navega√ß√£o por abas em layout vertical em mobile
  - Grid de pets em coluna √∫nica em smartphones
  - Grid de formul√°rios adaptativo: 2-3 colunas em desktop ‚Üí 1 coluna em mobile @640px
  - Inputs com tamanho de fonte 16px para evitar zoom autom√°tico no iOS
  - Bot√µes submit com largura 100% em mobile para melhor √°rea de toque
- Documenta√ß√£o expandida com exemplos de como quebrar fun√ß√µes grandes em m√©todos menores e mais focados
- Estabelecidos padr√µes de nomenclatura mais descritiva para vari√°veis e fun√ß√µes
- Documenta√ß√£o do add-on Agenda atualizada para refletir limpeza de cron jobs na desativa√ß√£o
- **Agenda Add-on**: Navega√ß√£o simplificada e melhorias visuais:
  - Bot√µes de navega√ß√£o consolidados de 7 para 6, organizados em 3 grupos l√≥gicos
  - Navega√ß√£o: [‚Üê Anterior] [Hoje] [Pr√≥ximo ‚Üí] | [üìÖ Semana] [üìã Todos] | [‚ûï Novo]
  - CSS extra√≠do de inline (~487 linhas) para arquivo externo `assets/css/agenda-addon.css`
  - Border-left de status reduzida de 4px para 3px (estilo mais clean)
  - Remo√ß√£o de transform: translateY(-1px) em hover dos bot√µes (menos movimento visual)
  - Remo√ß√£o de sombras decorativas (apenas bordas 1px solid)

#### Changed (Alterado)
- **Client Portal Add-on (v2.0.0)**: M√©todo de autentica√ß√£o completamente substitu√≠do
  - Sistema antigo de login com usu√°rio/senha do WordPress REMOVIDO
  - Novo sistema baseado 100% em tokens (magic links)
  - Shortcode `[dps_client_login]` agora exibe apenas a tela de acesso minimalista
  - M√©todo `render_client_logins_page()` completamente reescrito (de ~400 para ~100 linhas)
  - Interface administrativa totalmente nova baseada em templates
  - Compatibilidade retroativa mantida via fallback no m√©todo `get_authenticated_client_id()`
  - **IMPORTANTE**: Clientes existentes precisar√£o solicitar novo link de acesso na primeira vez ap√≥s a atualiza√ß√£o

#### Security (Seguran√ßa)
- **Plugin Base**: Adicionada prote√ß√£o CSRF no logout do painel DPS
  - Novo m√©todo `DPS_Base_Frontend::handle_logout()` agora requer nonce v√°lido (`_wpnonce`)
  - Prote√ß√£o contra logout for√ßado via links maliciosos (CSRF)
  - Sanitiza√ß√£o adequada de par√¢metros GET
  - **IMPORTANTE**: Links de logout devem incluir `wp_nonce_url()` com action `dps_logout`
- **Client Portal Add-on (v2.0.0)**: Melhorias de seguran√ßa no sistema de sess√µes e e-mails
  - Configura√ß√£o de flags de seguran√ßa em cookies de sess√£o (httponly, secure, samesite=Strict)
  - Modo estrito de sess√£o habilitado (use_strict_mode)
  - Regenera√ß√£o sistem√°tica de session_id em autentica√ß√£o (prote√ß√£o contra session fixation)
  - E-mails enviados apenas em formato plain text (prote√ß√£o contra social engineering)
  - Sanitiza√ß√£o com `sanitize_textarea_field()` em vez de `wp_kses_post()` para e-mails

#### Fixed (Corrigido)
- **Internacionaliza√ß√£o (i18n)**: Corrigidas strings hardcoded n√£o traduz√≠veis
  - **Plugin Base**: 6 strings envolvidas em fun√ß√µes de tradu√ß√£o
    - Mensagens WhatsApp de cobran√ßa (individual e conjunta) agora usam `__()` com 'desi-pet-shower'
    - Mensagem de deprecia√ß√£o do shortcode `[dps_configuracoes]` agora usa `__()`
    - Placeholder "Digite ou selecione" no campo de ra√ßa agora usa `esc_attr__()`
    - Mensagem de sucesso de envio de hist√≥rico agora usa `esc_html__()`
    - Prompt de email JavaScript agora usa `esc_js( __() )`
  - **Finance Add-on**: 2 mensagens WhatsApp de cobran√ßa agora usam `__()` com 'dps-finance-addon'
- **Internacionaliza√ß√£o (i18n)**: Corrigidos text domains incorretos em 4 add-ons
  - **Communications Add-on**: Todas strings (20 ocorr√™ncias) atualizadas de 'desi-pet-shower' para 'dps-communications-addon'
  - **Stock Add-on**: Todas strings (15 ocorr√™ncias) atualizadas de 'desi-pet-shower' para 'dps-stock-addon'
  - **Groomers Add-on**: Todas strings (12 ocorr√™ncias) atualizadas de 'desi-pet-shower' para 'dps-groomers-addon'
  - **Loyalty Add-on**: Todas strings (8 ocorr√™ncias) atualizadas de 'desi-pet-shower' para 'dps-loyalty-addon'
  - Headers dos plugins tamb√©m atualizados para refletir text domains corretos
- **Agenda Add-on**: Corrigido aviso incorreto de depend√™ncia do Finance Add-on no painel administrativo
  - **Problema**: Mensagem "O Finance Add-on √© recomendado para funcionalidade completa de cobran√ßas" aparecia mesmo com Finance ativo
  - **Causa raiz**: Verifica√ß√£o `class_exists('DPS_Finance_API')` no construtor executava antes do Finance carregar (ordem alfab√©tica de plugins)
  - **Solu√ß√£o**: Movida verifica√ß√£o do construtor para hook `plugins_loaded` (novo m√©todo `check_finance_dependency()`)
  - **Impacto**: Aviso agora aparece apenas quando Finance realmente n√£o est√° ativo
  - **Arquivo alterado**: `add-ons/desi-pet-shower-agenda_addon/desi-pet-shower-agenda-addon.php`
- **Plugin Base**: Corrigido erro "Falha ao atualizar. A resposta n√£o √© um JSON v√°lido" ao inserir shortcode `[dps_base]` no Block Editor
  - **Causa raiz**: M√©todo `render_app()` processava logout e POST requests ANTES de iniciar output buffering (`ob_start()`)
  - **Sintoma**: Block Editor falhava ao validar shortcode porque redirects/exits causavam conflito com resposta JSON esperada
  - **Solu√ß√£o**: Movido processamento de logout para hook `init` (novo m√©todo `DPS_Base_Frontend::handle_logout()`)
  - **Solu√ß√£o**: Removida chamada redundante a `handle_request()` dentro de `render_app()` (j√° processado via `init`)
  - **Impacto**: Shortcode `[dps_base]` agora √© m√©todo puro de renderiza√ß√£o sem side-effects, compat√≠vel com Block Editor
  - **Arquivos alterados**: 
    - `plugin/desi-pet-shower-base_plugin/desi-pet-shower-base.php` (adicionado logout ao `maybe_handle_request()`)
    - `plugin/desi-pet-shower-base_plugin/includes/class-dps-base-frontend.php` (novo m√©todo `handle_logout()`, `render_app()` simplificado)
  - **Verifica√ß√£o**: Todos os outros shortcodes (`[dps_agenda_page]`, `[dps_client_portal]`, `[dps_registration_form]`, etc.) j√° seguem o padr√£o correto
- **Client Portal Add-on**: Corrigido problema de layout onde o card "Portal do Cliente" aparecia antes do cabe√ßalho do tema
  - **Causa raiz**: M√©todo `render_portal_shortcode()` estava chamando `ob_end_clean()` seguido de `include`, causando output direto em vez de retornar HTML via shortcode
  - **Sintoma**: Card do portal aparecia ANTES do menu principal do tema YOOtheme, como se estivesse "encaixado no header"
  - **Solu√ß√£o**: Substitu√≠do `ob_end_clean() + include + return ''` por `ob_start() + include + return ob_get_clean()`
  - **Impacto**: Portal agora renderiza corretamente DENTRO da √°rea de conte√∫do da p√°gina, respeitando header/footer do tema
  - **Arquivos alterados**: `add-ons/desi-pet-shower-client-portal_addon/includes/class-dps-client-portal.php` (linhas 710-723)
- **Groomers Add-on**: Corrigido fatal error ao renderizar se√ß√£o no front-end via shortcode [dps_base]
  - Problema: fun√ß√£o `add_settings_error()` s√≥ existe no contexto admin (wp-admin)
  - Solu√ß√£o: adicionada verifica√ß√£o `function_exists('add_settings_error')` antes de todas as chamadas
  - Impacto: aba "Groomers" agora funciona corretamente no Painel de Gest√£o DPS sem fatal errors
  - Mensagens no front-end exibidas via `DPS_Message_Helper`, mantendo compatibilidade com admin
- **Agenda Add-on**: Corrigido syntax error pr√©-existente (linha 936) com closing brace √≥rf√£o e c√≥digo quebrado usando vari√°veis indefinidas ($client_id, $pet_post, $date, $valor)
- Implementado feedback visual ap√≥s todas as opera√ß√µes principais:
  - Mensagens de sucesso ao salvar clientes, pets e agendamentos
  - Mensagens de confirma√ß√£o ao excluir registros
  - Alertas de erro quando opera√ß√µes falham
  - Feedback claro e imediato eliminando confus√£o sobre conclus√£o de a√ß√µes
- Evitado retorno 401 e mensagem "Unauthorized" em acessos comuns ao site, aplicando a valida√ß√£o do webhook do Mercado Pago apenas quando a requisi√ß√£o traz indicadores da notifica√ß√£o
- Corrigido potencial problema de cron jobs √≥rf√£os ao desativar add-on Agenda
- **Formul√°rios de cadastro**: Problemas cr√≠ticos de UX resolvidos:
  - ‚úÖ Formul√°rio de Pet sem fieldsets (17+ campos desorganizados)
  - ‚úÖ Campos obrigat√≥rios sem indica√ß√£o visual
  - ‚úÖ Placeholders ausentes em CPF, telefone, email, endere√ßo
  - ‚úÖ Upload de foto sem preview
  - ‚úÖ Bot√µes de submit sem desabilita√ß√£o durante processamento (risco de duplicatas)
  - ‚úÖ Labels t√©cnicos substitu√≠dos por termos mais claros
  - ‚úÖ Estilos inline substitu√≠dos por classes CSS reutiliz√°veis

#### Deprecated (Depreciado)
- **Client Portal Add-on (v2.0.0)**: Sistema de login com usu√°rio/senha descontinuado
  - Shortcode `[dps_client_login]` ainda existe mas comportamento mudou (n√£o exibe mais formul√°rio de login)
  - M√©todo `maybe_create_login_for_client()` ainda √© executado mas n√£o tem mais utilidade pr√°tica
  - M√©todo `get_client_id_for_current_user()` ainda funciona como fallback mas ser√° removido em v3.0.0
  - M√©todos relacionados a senha ser√£o removidos em vers√£o futura: `render_login_shortcode()` (parcialmente mantido), a√ß√µes de reset/send password
- **Agenda Add-on**: M√©todo `get_services_details_ajax()` - L√≥gica movida para Services Add-on (delega para `DPS_Services_API::get_services_details()`, mant√©m compatibilidade com fallback)
- **Agenda Add-on**: Endpoint AJAX `dps_get_services_details` agora √© gerenciado pelo Services Add-on (Agenda mant√©m por compatibilidade)
- **Finance Add-on**: `dps_parse_money_br()` - Use `DPS_Money_Helper::parse_brazilian_format()` (retrocompat√≠vel, aviso de deprecia√ß√£o)
- **Finance Add-on**: `dps_format_money_br()` - Use `DPS_Money_Helper::format_to_brazilian()` (retrocompat√≠vel, aviso de deprecia√ß√£o)
- **Loyalty Add-on**: `dps_format_money_br()` - Use `DPS_Money_Helper::format_to_brazilian()` (retrocompat√≠vel, aviso de deprecia√ß√£o)
- **Agenda Add-on**: Shortcode `[dps_charges_notes]` - Use `[dps_fin_docs]` do Finance (redirect autom√°tico, mensagem de deprecia√ß√£o)

#### Refactoring (Interno)
- **Plugin Base + Agenda Add-on**: Centraliza√ß√£o completa da formata√ß√£o de WhatsApp em `DPS_Phone_Helper::format_for_whatsapp()`
  - Removido m√©todo privado `format_whatsapp_number()` de `DPS_Base_Frontend` (13 linhas duplicadas)
  - Removido m√©todo wrapper deprecado `format_whatsapp_number()` de `DPS_Agenda_Addon` (19 linhas)
  - Total de 32 linhas de c√≥digo duplicado eliminadas
  - Todas as chamadas agora usam diretamente `DPS_Phone_Helper::format_for_whatsapp()`
  - **Benef√≠cios**: elimina√ß√£o de duplica√ß√£o, manuten√ß√£o simplificada, consist√™ncia entre add-ons
  - **Arquivos modificados**: `class-dps-base-frontend.php`, `desi-pet-shower-agenda-addon.php`
- **Services Add-on**: Removido header duplicado de plugin no arquivo `dps_service/desi-pet-shower-services-addon.php` (mant√©m apenas no wrapper)
- **Subscription Add-on**: Removido header duplicado de plugin no arquivo `dps_subscription/desi-pet-shower-subscription-addon.php` (mant√©m apenas no wrapper)
- **Services Add-on**: Centraliza√ß√£o completa de l√≥gica de servi√ßos e c√°lculo de pre√ßos via `DPS_Services_API` (redu√ß√£o de duplica√ß√£o, separa√ß√£o de responsabilidades)
- **Arquitetura**: Centraliza√ß√£o completa de l√≥gica financeira no Finance Add-on (elimina√ß√£o de duplica√ß√£o, redu√ß√£o de acoplamento)
- **Agenda Add-on**: Removidas ~55 linhas de SQL direto para `dps_transacoes` (agora usa sincroniza√ß√£o autom√°tica via hooks do Finance)
- **Fun√ß√µes monet√°rias**: Todas as chamadas legadas `dps_format_money_br()` e `dps_parse_money_br()` substitu√≠das por `DPS_Money_Helper`
  - Finance Add-on: 11 substitui√ß√µes (4x parse, 7x format)
  - Loyalty Add-on: 2 substitui√ß√µes (format)
  - Services Add-on: 1 substitui√ß√£o (parse com class_exists)
  - Client Portal Add-on: 1 substitui√ß√£o (format com class_exists)
  - Refactoring Examples: 1 substitui√ß√£o (parse)
  - Fun√ß√µes legadas mantidas como wrappers deprecados para compatibilidade retroativa
  - Garantia de que `DPS_Money_Helper` √© sempre usado internamente, eliminando duplica√ß√£o de l√≥gica
- **Finance Add-on**: `cleanup_transactions_for_appointment()` refatorado para delegar para `DPS_Finance_API`
- **Preven√ß√£o de race conditions**: Apenas Finance escreve em dados financeiros (fonte de verdade √∫nica)
- **Melhoria de manutenibilidade**: Mudan√ßas financeiras centralizadas em 1 lugar (Finance Add-on API p√∫blica)
- Reestrutura√ß√£o completa do CSS administrativo em `dps-base.css`:
  - Simplifica√ß√£o da classe `.dps-alert` removendo pseudo-elementos decorativos e sombras
  - Redu√ß√£o da paleta de cores de status de 4+ variantes para 3 cores essenciais
  - Padroniza√ß√£o de bordas (1px ou 4px) e espa√ßamentos (20px padding, 32px entre se√ß√µes)
  - Adi√ß√£o de media queries para responsividade b√°sica (480px, 768px, 1024px breakpoints)
  - Adi√ß√£o de classes para grid de formul√°rios e componentes visuais (fieldsets, upload, checkbox)
- Melhorias estruturais em `class-dps-base-frontend.php`:
  - Extra√ß√£o de l√≥gica de mensagens para helper dedicado (`DPS_Message_Helper`)
  - Separa√ß√£o de campos de formul√°rio em fieldsets sem√¢nticos
  - Padroniza√ß√£o de t√≠tulos com hierarquia H1 ‚Üí H2 ‚Üí H3 em todas as se√ß√µes
  - Adi√ß√£o de chamadas `display_messages()` no in√≠cio de cada se√ß√£o do painel
- Melhorias em p√°ginas administrativas de add-ons:
  - Logs: organiza√ß√£o de filtros e tabelas seguindo padr√£o minimalista
  - Clientes, pets e agendamentos: consist√™ncia visual com novo sistema de feedback
  - Formul√°rios dos add-ons alinhados ao estilo visual do n√∫cleo
- **Agenda Add-on**: Separa√ß√£o de responsabilidades e melhoria de arquitetura:
  - Extra√ß√£o de 487 linhas de CSS inline para arquivo dedicado `assets/css/agenda-addon.css`
  - Cria√ß√£o de componente modal reutiliz√°vel em `assets/js/services-modal.js` (acess√≠vel, com ARIA)
  - Atualiza√ß√£o de `enqueue_assets()` para carregar CSS/JS externos (habilita cache do navegador e minifica√ß√£o)
  - Integra√ß√£o do modal com fallback para alert() caso script n√£o esteja carregado
  - Benef√≠cios: separa√ß√£o de responsabilidades, cache do navegador, minifica√ß√£o poss√≠vel, manutenibilidade melhorada

#### Fixed (Corrigido)
- **Groomers Add-on**: Corrigido erro fatal "Call to undefined function settings_errors()" no front-end ao usar shortcode [dps_base]
  - **Problema**: `settings_errors()` √© fun√ß√£o exclusiva do WordPress admin, n√£o dispon√≠vel no front-end
  - **Impacto**: Fatal error na se√ß√£o Groomers do Painel de Gest√£o DPS (shortcode)
  - **Solu√ß√£o**: Implementada separa√ß√£o de contexto:
    - M√©todo `handle_new_groomer_submission()` agora aceita par√¢metro `$use_frontend_messages`
    - Front-end (`render_groomers_section`): usa `DPS_Message_Helper::add_error/add_success()` e `display_messages()`
    - Admin (`render_groomers_page`): usa `add_settings_error()` e `settings_errors()` com guard `function_exists()`
  - O shortcode [dps_base] agora funciona normalmente no front-end sem fatal errors
- Corrigido erro fatal "Call to undefined function" ao ativar add-ons de Communications e Loyalty:
  - **Communications**: fun√ß√£o `dps_comm_init()` era chamada antes de ser declarada (linha 214)
  - **Loyalty**: fun√ß√£o `dps_loyalty_init()` era chamada antes de ser declarada (linha 839)
  - **Solu√ß√£o**: declarar fun√ß√µes primeiro, depois registr√°-las no hook `plugins_loaded` (padr√£o seguido pelos demais add-ons)
  - Os add-ons agora inicializam via `add_action('plugins_loaded', 'dps_*_init')` em vez de chamada direta em escopo global

---

### [2025-11-17] v0.3.0 ‚Äî Indique e Ganhe

#### Added (Adicionado)
- Criado m√≥dulo "Indique e Ganhe" no add-on de fidelidade com c√≥digos √∫nicos, tabela `dps_referrals`, cadastro de indica√ß√µes e recompensas configur√°veis por pontos ou cr√©ditos para indicador e indicado.
- Inclu√≠da se√ß√£o administrativa para ativar o programa, definir limites e tipos de bonifica√ß√£o, al√©m de exibir c√≥digo/link de convite e status de indica√ß√µes no Portal do Cliente.
- Adicionado hook `dps_finance_booking_paid` no fluxo financeiro e campo de c√≥digo de indica√ß√£o no cadastro p√∫blico para registrar rela√ß√µes entre clientes.

---

### [2025-11-17] v0.2.0 ‚Äî Campanhas e fidelidade

#### Added (Adicionado)
- Criado add-on `desi-pet-shower-loyalty` com programa de pontos configur√°vel e fun√ß√µes globais para cr√©dito e resgate.
- Registrado CPT `dps_campaign` com metabox de elegibilidade e rotina administrativa para identificar clientes alvo.
- Inclu√≠da tela "Campanhas & Fidelidade" no menu principal do DPS com resumo de pontos por cliente e gatilho manual de campanhas.

---

### [2024-01-15] v0.1.0 ‚Äî Primeira vers√£o p√∫blica

#### Added (Adicionado)
- Estrutura inicial do plugin base com hooks `dps_base_nav_tabs_*` e `dps_settings_*`.
- Add-on Financeiro com sincroniza√ß√£o da tabela `dps_transacoes`.
- Guia inicial de configura√ß√£o e checklist de seguran√ßa do WordPress.

#### Security (Seguran√ßa)
- Nonces aplicados em formul√°rios de painel para evitar CSRF.
